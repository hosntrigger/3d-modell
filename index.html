<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Klappmouse 3D – Farbwechsel</title>

    <!-- model-viewer (nur Modul-Build, Version fixiert) -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer@4.1.0/dist/model-viewer.min.js"></script>

    <style>
      :root {
        color-scheme: light;
        --page-bg: #ffffff;
        --text: #111;
        --muted: #666;
        --panel: #f9f9f9;
        --brand: #0ea5e9;
      }
      * { box-sizing: border-box; }
      html, body { margin:0; height:100%; background:var(--page-bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
      .wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
      header { text-align: center; margin-bottom: 14px; }
      header h1 { margin: 0; font-size: clamp(24px, 4vw, 34px); }
      header p { margin: 6px 0 0; color: var(--muted); }
      model-viewer {
        width: 100%;
        height: min(70vh, 80vw);
        background: var(--panel);
        border-radius: 16px;
        box-shadow: 0 10px 36px rgba(0,0,0,.08);
      }
      .controls {
        display:flex; flex-wrap:wrap; gap:10px; align-items:center;
        margin: 14px 0 4px;
      }
      .chip {
        appearance: none; border:1px solid #ddd; padding:8px 12px; border-radius: 999px;
        background:white; cursor:pointer; font-weight:600;
      }
      .chip:hover { border-color:#ccc; }
      .swatch {
        width: 28px; height: 28px; border-radius: 50%; border:1px solid #ddd; cursor:pointer;
      }
      .picker { display:flex; align-items:center; gap:8px; margin-left:auto; }
      .note { font-size:12px; color:var(--muted); margin-top: 6px; }
      .alert { background:#fff3cd; color:#7a5b00; border:1px solid #ffe08a; padding:8px 12px; border-radius:10px; display:none; margin: 10px 0; }
      footer { text-align:center; color:var(--muted); font-size:12px; margin:18px 0 8px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Klappmouse 3D</h1>
        <p>Farbe des Materials <code>plastik1</code> live ändern</p>
      </header>

      <div id="alert" class="alert">Material <b>plastik1</b> wurde nicht gefunden. Verfügbare Namen sind in der Browser-Konsole gelistet.</div>

      <model-viewer id="mv"
        src="assets/klappmouse_bake_0003.glb"
        alt="3D-Modell: Klappmouse"
        camera-controls
        auto-rotate
        environment-image="neutral"
        exposure="1.05"
        shadow-intensity="0.22"
        shadow-softness="0.75"
        tone-mapping="aces"
        reveal="auto">
      </model-viewer>

      <!-- Steuerleiste -->
      <div class="controls">
        <!-- Preset-Farben (Swatches) -->
        <button class="swatch" style="background:#111111" title="#111111" data-color="#111111"></button>
        <button class="swatch" style="background:#e11d48" title="#e11d48" data-color="#e11d48"></button>
        <button class="swatch" style="background:#0ea5e9" title="#0ea5e9" data-color="#0ea5e9"></button>
        <button class="swatch" style="background:#10b981" title="#10b981" data-color="#10b981"></button>
        <button class="swatch" style="background:#ffffff" title="#ffffff" data-color="#ffffff"></button>

        <!-- Schnell-Buttons -->
        <button class="chip" data-color="#222222">Dunkel</button>
        <button class="chip" data-color="#dddddd">Hell</button>
        <button class="chip" id="resetBtn">Zurücksetzen</button>

        <!-- Farbpicker -->
        <div class="picker">
          <label for="colorInput" style="font-size:14px;color:var(--muted)">Eigene Farbe:</label>
          <input id="colorInput" type="color" value="#0ea5e9" />
          <button class="chip" id="applyColor">Übernehmen</button>
        </div>
      </div>

      <div class="note">Hinweis: Wenn das Material eine Base-Color-Textur hat, wirkt die Farbe als Tönung über der Textur.</div>

      <footer>Präsentiert mit <code>&lt;model-viewer&gt;</code></footer>
    </div>

    <script>
      const mv = document.getElementById('mv');
      const targetMaterialName = 'mouse_1'; // Zielmaterial (case-insensitive)

      function hexToRgba01(hex, a = 1) {
        const m = hex.replace('#','').trim();
        const bigint = parseInt(m, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return [r/255, g/255, b/255, a];
      }

      function findMaterialByName(materials, name) {
        const n = name.toLowerCase();
        return materials.find(m => (m?.name || '').toLowerCase() === n) || null;
      }

      async function setMaterialColor(hex) {
        await mv?.model?.materials;
        const mats = mv?.model?.materials || [];
        if (!mats.length) return;

        let mat = findMaterialByName(mats, targetMaterialName);
        if (!mat) {
          document.getElementById('alert').style.display = 'block';
          console.warn('Material nicht gefunden. Verfügbar:', mats.map(m => m.name));
          // Fallback: erstes Material einfärben
          mat = mats[0];
        } else {
          document.getElementById('alert').style.display = 'none';
        }

        const rgba = hexToRgba01(hex, 1.0);
        mat.pbrMetallicRoughness.setBaseColorFactor(rgba);
        // Optional: leichte Standardwerte für ein „Kunststoff“-Gefühl
        // mat.pbrMetallicRoughness.metallicFactor = 0.0;
        // mat.pbrMetallicRoughness.roughnessFactor = 0.5;
      }

      function resetMaterialColor() {
        // Setzt den BaseColorFactor auf neutral (weiß, unverändert)
        setMaterialColor('#ffffff');
      }

      // UI-Events
      document.querySelectorAll('.swatch,[data-color]').forEach(el => {
        el.addEventListener('click', e => {
          const hex = el.getAttribute('data-color');
          if (hex) setMaterialColor(hex);
        });
      });

      document.getElementById('applyColor').addEventListener('click', () => {
        const hex = document.getElementById('colorInput').value || '#ffffff';
        setMaterialColor(hex);
      });

      document.getElementById('resetBtn').addEventListener('click', resetMaterialColor);

      // Nach dem Laden: Materialnamen in der Konsole anzeigen, einmal auf „hell“ setzen
      mv.addEventListener('load', () => {
        const mats = mv?.model?.materials || [];
        console.log('Materialien im Modell:', mats.map(m => m.name));
        // Ein dezentes Standard-Setup (optional):
        setMaterialColor('#dddddd');
      });
    </script>
  </body>
</html>
